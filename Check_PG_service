#!/bin/bash

# é…ç½®é‚®ä»¶å‘Šè­¦çš„æ”¶ä»¶äººé‚®ç®±åœ°å€
ALERT_EMAIL="xx.xx.xx@xxxx.com"

# è·å–ä¸»æœºåå’Œ IP åœ°å€
HOSTNAME=$(hostname)
IP_ADDRESS=$(hostname -I | awk '{print $1}')

# é‚®ä»¶ä¸»é¢˜ï¼šåŒ…å«ä¸»æœºåå’Œ IP åœ°å€
SUBJECT="[PG Alert] PG process is not running $HOSTNAME ($IP_ADDRESS)"

# ä½¿ç”¨ pgrep æ£€æµ‹ PostgreSQL è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
PGPROC=$(pgrep -u postgres -x postgres)

# Function: Create separator line
separator() {
    local width=${1:-60}
    printf '%*s\n' "$width" '' | tr ' ' '='
}
# å¦‚æœ PostgreSQL è¿›ç¨‹æœªè¿è¡Œï¼Œåˆ™å‘é€å‘Šè­¦é‚®ä»¶
if [ -z "$PGPROC" ]; then
  # é‚®ä»¶æ­£æ–‡å†…å®¹ï¼Œæ ¼å¼åŒ–
  DETECTION_TIME=$(date +"%Y-%m-%d %H:%M:%S %Z")
  ALERT_MESSAGE="$(separator 60)\n\n"
  ALERT_MESSAGE+="ğŸš¨Critical: PG process is not runningğŸš¨\n"
  ALERT_MESSAGE+="ğŸ“…Detaction Time: $DETECTION_TIME \n\n"
  ALERT_MESSAGE+="$(separator 60)\n"
  ALERT_MESSAGE+="ğŸ”Error Details: \n\n"
  ALERT_MESSAGE+="PG process is not running !"
  # å‘é€é‚®ä»¶ï¼Œç¡®ä¿é‚®ä»¶å†…å®¹æ ¼å¼æ­£ç¡®
  echo -e "$ALERT_MESSAGE" | mailx -s "$SUBJECT" $ALERT_EMAIL
else
  # PostgreSQL è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œæ‰“å°è¿›ç¨‹ä¿¡æ¯
  echo -e "PostgreSQL process is running. Below are the details:\n"
  ps aux | grep '[p]ostgres'  # åªåˆ—å‡º PostgreSQL è¿›ç¨‹
  echo -e "\n$(separator 60)"
  echo -e "PostgreSQL process is running on $HOSTNAME ($IP_ADDRESS) - $(date +"%Y-%m-%d %H:%M:%S")"
  echo -e "$(separator 60)"
fi
